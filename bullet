local UIS = game:GetService("UserInputService")

local config = getgenv().Krylon['Bullet Modification']
local multiplier = config.Options.Multiplier or 0.01
local enabled = config.Options.Enabled
local toggleMode = config.Options.ToggleMode
local keybinds = config.Options.Keybinds

local spreadEnabled = enabled
local toggleState = toggleMode and false or true

local spreadMultiplier = multiplier
local old
old = hookfunction(math.random, function(...)
    local args = { ... }

    if checkcaller() then
        return old(...)
    end

    if not spreadEnabled or not toggleState then
        return old(...)
    end

    if (#args == 0) then
        return old(...) * spreadMultiplier
    elseif (#args == 1) and (args[1] == -0.05 or args[1] == -0.1) then
        return old(...) * spreadMultiplier
    elseif (#args == 2) and (args[1] == -0.05 and args[2] == 0.05) then
        return old(...) * spreadMultiplier
    end

    return old(...)
end)

UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed or not input.KeyCode then return end
    local key = input.KeyCode.Name

    if key == keybinds['ToggleSpread'] then
        if toggleMode then
            toggleState = not toggleState
        else
            toggleState = true
        end

    elseif key == keybinds['Spread +0.1'] then
        spreadMultiplier = spreadMultiplier + 0.1

    elseif key == keybinds['Spread -0.1'] then
        spreadMultiplier = math.max(0, spreadMultiplier - 0.1)
    end
end)

UIS.InputEnded:Connect(function(input)
    if not input.KeyCode then return end
    local key = input.KeyCode.Name

    if not toggleMode and key == keybinds['ToggleSpread'] then
        toggleState = false
    end
end)
